name: Daily Secret Mission

on:
  schedule:
    # K√∂rs klockan 08:00 UTC varje dag
    - cron: '0 8 * * *'
  
  # G√∂r s√• vi kan k√∂ra den manuellt ocks√• f√∂r att testa
  workflow_dispatch:

jobs:
  send-mission:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Mission
        id: mission
        run: |
          # Lista p√• hemliga meddelanden
          MSGS=("ATTACK AT DAWN" "BUY MORE COFFEE" "DEPLOY TO PROD" "WATCH YOUR BACK" "SWEET BURGERS TONIGHT" "MEET AT THE OLD MILL" "THE EAGLE HAS LANDED" "CODE RED ALERT" "MISSION ACCOMPLISHED" "STAY VIGILANT")
          # V√§lj ett slumpm√§ssigt
          SECRET=${MSGS[$RANDOM % ${#MSGS[@]}]}
          echo "plain_text=$SECRET" >> $GITHUB_OUTPUT

      - name: Encrypt Mission (Debug Mode)
        id: encrypt
        run: |
          # Anropar API som ligger live p√• AWS f√∂r att kryptera
          # AWS l√§nk
          API_URL="http://enigmaapp-env.eba-bzpd3etd.eu-north-1.elasticbeanstalk.com"
          
          # H√§mta meddelandet
          MSG="${{ steps.mission.outputs.plain_text }}"
          
          echo "--- DEBUG INFO ---"
          echo "Connecting to: $API_URL/encrypt"
          echo "Message to encrypt: $MSG"
          
          # 2. K√∂r CURL med -v (verbose) f√∂r att se om det kraschar
          # Vi sparar svaret i en variabel
          RESPONSE=$(curl -v -G --data-urlencode "text=$MSG" "$API_URL/encrypt" 2>&1)
          
          echo "Full Response from Server:"
          echo "$RESPONSE"
          
          # 3. F√∂rs√∂k fiska ut den sista raden (som borde vara koden)
          # Detta √§r en enkel hack-l√∂sning f√∂r att f√•nga texten √§ven om curl babblar
          CLEAN_CODE=$(curl -s -G --data-urlencode "text=$MSG" "$API_URL/encrypt")
          
          echo "Clean Code extracted: $CLEAN_CODE"
          echo "--- END DEBUG ---"

          # 4. Skicka till output (om den √§r tom s√§tter vi en feltext)
          if [ -z "$CLEAN_CODE" ]; then
            echo "encrypted_text=ERROR_CHECK_LOGS" >> $GITHUB_OUTPUT
          else
            echo "encrypted_text=$CLEAN_CODE" >> $GITHUB_OUTPUT
          fi

      - name: Send to Discord
        uses: rjstone/discord-webhook-notify@v1
        with:
          severity: warn
          username: "HQ Commander"
          details: "üïµÔ∏è‚Äç‚ôÇÔ∏è **INTERCEPTED SIGNAL**\n\nCode: `${{ steps.encrypt.outputs.encrypted_text }}`\n\nDecrypt this immediately at the terminal!"
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
          avatarUrl: "https://cdn-icons-png.flaticon.com/512/3069/3069172.png"